<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
        <link id=favicon href="/img/hushsbay.png" rel="shortcut icon" type="image/x-icon"/>
        <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
        <title>조직도</title>
        <link rel="stylesheet" href="/common/common.css">
        <style>
            .container { 
                width: 100%; height: 100%; padding: 0 5px;
                display: flex; flex-direction: column; 
                background-color: #eaeaea;
            }

            .top {
                height:50px;
                display: flex; align-items: center;
                background-color: transparent; /*border:1px solid darkgray; border-bottom: 0;*/
            }

            .main {
                height: 100%; 
                display: flex; flex: 1; overflow-y: auto;
                background-color: white;
            }

            .bottom {
                height: 50px;
                display: flex; justify-content: space-between; align-items: center;
                background-color: transparent; /*border:1px solid darkgray; border-top: 0;*/
            }

            #listMain { 
                display: flex; flex-direction: column; flex-grow: 1; overflow-y: auto;
				border: 1px solid darkgray;
            }

            #panSel { 
                min-width: 100px; max-width: 250px; margin-left: auto;
                display: none; flex-direction: column;  
                overflow: hidden; border:1px solid darkgray; border-left: 0;
            }

            #panSelTop { 
                height: 24px; 
                display: flex; align-items: center; justify-content: space-between; 
                border-bottom: 1px solid darkgray;
            }

			.mem {
				padding-top: 4px; margin: 4px 4px 0px 4px;
				display: flex; flex-direction: column; overflow: auto; 
				background-color: #fdf5f6; border: 1px solid lightgray;  
			}

            .memNm { 
				height: 20px; margin-left: 3px;
				font-size: 12px; color: #005192; cursor: pointer;  
			}

            .memSel { 
				background:#b2e2f8 
			}
        </style>
        <script src="/plugin/jquery-3.4.1.min.js"></script>
		<script src="/plugin/jquery-ui-smoothness-1.12.1.min.js"></script>
        <script>
			let g_from, g_nodeToGet, g_comp, g_expandTo, g_expandAllDept, g_singleSelect
			let g_nodeIndent = 24
            let g_rs, g_list, g_listSel

            document.oncontextmenu = new Function("return false;")

			const procSelect = (nodekind, idx) => {
        	    try {
        	    	const tag = $("#sel_" + idx)
        	        const _chk = tag.is(":checked")
        	    	const row1 = g_rs.list[idx]
        	    	let _id, _nm, _str
        	    	if (nodekind == "C") {
        	    		_id = row1.ORG_CD
        	    		_nm = row1.ORG_NM
        	    	} else if (nodekind == "D") {
        	    		_id = row1.ORG_CD
        	    		_nm = row1.ORG_NM + "/" + row1.TOP_ORG_NM
        	    	} else {
        	    		_id = row1.USER_ID
        	    		_nm = row1.USER_NM + "/" + row1.ORG_NM
        	    	}
        	        if (_chk) {
        	            if ($("#add_" + _id).length > 0) {
        	                $("#add_" + _id).effect("highlight", { color: hush.cons.color_fadein }, 500)
        	                return
        	            }
        	            let _html = "<div id=add_" + _id + " class=mem>"
        	            _html += "      <div id=addnm_" + _id + " idx=" + idx + " class='coDotDot memNm members'>" + _nm + "</div>"
          	            _html += "   </div>"
        	            g_listSel.append(_html)
        	            g_listSel.scrollTop(g_listSel.prop("scrollHeight"))
        	            const _idTag = $("#add_" + _id)
        	            _idTag.effect("highlight", { color: hush.cons.color_fadein }, 100)
        	            _idTag.off("click").on("click", function() {
        	            	hush.util.animAction(_idTag, () => { 
        	            		const _tag = $(".sel[code='" + _id + "']") //$("#sel_" + _id).prop("checked", false)
        	            		_tag[0].checked = false      
        	            		$(this).remove()
        	                    procMemPanel()
        	                })
        	            })
        	            _idTag.off("mouseover").on("mouseover", function() { $(this).addClass("memSel") })
        	            _idTag.off("mouseleave").on("mouseleave", function() { $(this).removeClass("memSel") })
        	            procMemPanel()
        	        } else {
        	            const _idTag = $("#add_" + _id)
						$("#add_" + _id).effect("highlight", { color: hush.cons.color_fadein }, 500)
        	            hush.util.animAction(_idTag, () => { 
        	            	_idTag.remove()
        	                procMemPanel()
        	            })
        	        }
        	    } catch (ex) {
        	    	hush.util.showEx(ex)
        	    }
        	}

			const procMemPanel = () => {
        	    const _cnt = $(".mem").length
        	    $("#cntSel").html(_cnt)
        	    if (_cnt > 0) {
        	        $("#panSel").css("display", "flex")
        	    } else {
        	        $("#panSel").hide()
        	        $("#select_all").prop("checked", false)
        	    }            
        	}

            const getOrgTree = async (obj) => {
	        	//nodeToGet = C(회사), D(부서), U(사용자)
				//comp = ALL 또는 회사코드(델리미터는 콤마(,)) / Default는 ALL
				//expandTo (클라이언트에서만 사용) = 0,1,2.. (0 : all collapsed (회사만 보임) / 99 : all expanded)
				//expandAllDept (클라이언트에서만 사용) = Y이면 임직원만 안보이게 접고 회사/부서는 모두 펼치기 (expandTo는 무시됨. nodeToGet=U일 경우만 의미있음)
				//$wise.onceJwtCall(g_payload, false, async function(token) {
					try {
						if (hush.util.isvoid(obj.nodeToGet)) obj.nodeToGet = "U"
						if (hush.util.isvoid(obj.comp)) obj.comp = "ALL"
						if (hush.util.isvoid(obj.expandTo) || obj.expandTo < 0) obj.expandTo = 0
						$('#spn_depth').html(parseInt(obj.expandTo) + 1)
						if (hush.util.isvoid(obj.expandAllDept)) obj.expandAllDept = ""			
						g_list.empty()
                        const rs = await hush.http.ajax("/org/orgtree", { obj : obj }) //{ token : token, user : g_user, obj : obj }
                        if (rs.code != hush.cons.CODE_OK) {
                        	hush.msg.showMsg(rs.msg)
                            return
						}
						g_rs = rs
				      	const _len = rs.list.length
						if (_len == 0) return
				      	const _objUpperLevel = { } //used for deciding child node's parent tag idx
				      	for (let i = 0; i < _len; i++) {
				        	const row = rs.list[i]
							const seq = row.SEQ
							const lvl = parseInt(row.LVL)
							const org_cd = row.ORG_CD
							const org_nm = row.ORG_NM
							const top_org_cd = row.TOP_ORG_CD
							const top_org_nm = row.TOP_ORG_NM
							const user_id = row.USER_ID
							const user_nm = row.USER_NM
							const mem_cnt = parseInt(row.MEM_CNT)
							//const nick_nm = row.NICK_NM
							//const job = row.JOB
							//const tel_no = row.TEL_NO
							//const ab_cd = row.AB_CD
							//const ab_nm = row.AB_NM
							const nodekind = (lvl == 0) ? "C" : (user_id ? "U" : "D") //회사(C) / 사용자(U)레벨은 소속 부서 레벨+1 /부서(D)
				          	let nodeStr, disp, hasChild = true, expanded, parentIdx = -1, _code
				          	if (i == _len - 1 || nodekind == "U" || parseInt(rs.list[i + 1].LVL) <= lvl) hasChild = false
				          	if (obj.expandAllDept == "Y") { //이 경우 obj.expandTo 무시됨
				          		if (nodekind == "U") {
				          			disp = "none"
				          		} else {
				          			disp = "flex"
				          		}
				          		if (hasChild && !rs.list[i + 1].USER_ID) expanded = true
				          	} else {
				          		disp = (lvl <= obj.expandTo) ? "flex" : "none"
				          		expanded = (lvl < obj.expandTo) ? true : false
				          	}
				          	if (lvl > 0 && _objUpperLevel[lvl - 1]) parentIdx = _objUpperLevel[lvl - 1]
				          	const expcolImg = (expanded) ? "minus_1.png" : "plus_1.png"
				          	const paddingLeft = lvl * g_nodeIndent + 3
				          	if (nodekind == "U") {
								nodeStr = user_nm + "/" + org_nm + "/" + top_org_nm
				          		_code = user_id
							} else {
				          		nodeStr = org_nm + (g_nodeToGet == "U" && nodekind == "D" && mem_cnt > 0 ? " <span style='font-size: 12px; color: dimgray'>(" + mem_cnt + ")</span>" : "")
				          		_code = org_cd
				          	}
				        	row.nodekind = nodekind
				        	row.dispstate = disp
				        	row.haschild = hasChild
				        	row.expanded = expanded
				        	row.parentIdx = parentIdx
				          	let _html = "<div id=row_" + i.toString() + " class=row style='min-height:40px;display:" + disp + ";flex-direction:row;align-items:center;justify-content:space-between;cursor:pointer;border-bottom:1px solid lightgray;padding-left:" + paddingLeft + "px'>"
				          	_html += "		<div style='display:flex;flex-direction:row;align-items:center;justify-content:flex-start;margin-right:5px'>"
				          	_html += "   		<input type=checkbox id=sel_" + i + " code=" + _code + " class=sel />"
				          	if (nodekind == "U") {
				          		_html += "		<img src='/img/ico_per.png' class=coImg16 style='margin-left:5px' />"
				          	} else {
				          		_html += "		<img src='/img/ico_dept.png' class=coImg16 style='margin-left:5px' />"
				          	}
			          		_html += "			<span style='white-space:nowrap;overflow:hidden;margin-left:5px'>" + nodeStr + "</span>"
				          	_html += "      </div>"				          	
				          	_html += "      <div style='width:100px;display:flex;align-items:center;justify-content:flex-end;margin-right:5px'>"
					        const dispImg = (hasChild) ? "" : " style='display:none'"
					        _html += "          <img id=expcol_" + i + " src='/img/" + expcolImg + "' class=coImg32" + dispImg + " />"
					        _html += "      </div>"
				          	_html += "  </div>"
				          	g_list.append(_html)
				          	_objUpperLevel[lvl] = i
				      	}				      	
				      	$(".sel").off("change").on("change", function(e) {  
				        	const _self = $(this)
				          	const _id = this.id //sel_2
				          	const _idx = parseInt(_id.substring(4)) //2
				          	const row = g_rs.list[_idx]
				          	const _bool = _self.prop("checked")
				          	if (row.nodekind == obj.nodeToGet) procSelect(row.nodekind, _idx)
				      		const _lenA = g_rs.list.length
				      		for (let i = _idx + 1; i < _lenA; i++) {
				      			const row1 = g_rs.list[i]
				      			if (row1.LVL <= row.LVL) break
				      			const _tag = $("#sel_" + i)
				      			_tag.prop("checked", _bool)
				      			if (row1.nodekind == obj.nodeToGet) setTimeout(() => { procSelect(row1.nodekind, i) }, 1)
				      		}
							if (g_singleSelect == "Y" && $(".members").length > 1) {
								hush.msg.msg("하나의 행만 선택 가능합니다.")
								return
							}
						})
				      	$(".row").off("click").on("click", async function(e) {
				          	if ($(e.target).is("input:checkbox")) return //checkbox를 클릭하면 checkbox event만 먹히도록 함
				          	const _id = this.id //row_2
				          	const _idx = parseInt(_id.substring(4)) //2
				          	const row = g_rs.list[_idx]
				          	const _tag = $(this)				          	
				          	const _level = parseInt(row.LVL)
				          	const _expanded = row.expanded
				          	const _hasChild = row.haschild
				          	if (_hasChild) {
				              	const row1 = g_rs.list[_idx + 1]
				              	if (!row1 || parseInt(row1.LVL) <= _level) {
				                  	procExpCol(_expanded, _tag, _idx)
				              	} else {
				                  	let j = 0
				                  	for (let i = _idx + 1; i < _len; i++) {
				                  		const row1 = g_rs.list[i]
				                      	const _nextTag = $("#row_" + i)
				                      	const levelNext = parseInt(row1.LVL) //const levelNext = parseInt(_nextTag.attr("level"))
				                      	if (levelNext <= _level) break
				                      	if (_expanded) { //if (_expanded == "Y") {
				                          	if (levelNext == _level + 1) {
				                              	row1.dispstate = "none" //_nextTag.attr("dispstate", "none")
				                          	} else {
				                          		row1.dispstate = _nextTag.css("display") //_nextTag.attr("dispstate", _nextTag.css("display"))
				                          	}
				                          	_nextTag.hide()
				                      	} else { //펼쳐야 함
				                          	if (levelNext == _level + 1) { //사용자(U)레벨은 소속 부서 레벨+1
				                              	_nextTag.css("display", "flex")
				                              	row1.dispstate = "flex"
				                          	} else {
				                          		if ($("#row_" + row1.parentIdx).css("display") == "none") { //if ($("#" + _nextTag.attr("parent")).css("display") == "none") {
				                                  	_nextTag.css("display", "none")
				                              	} else { //or recall child node's display state
				                                  	_nextTag.css("display", row1.dispstate)
				                              	}
				                          	}
				                      	}
				                      	j += 1
				                  	}  
				                  	if (j > 0) procExpCol(_expanded, _tag, _idx)
				              	}
				          	}
				      	})
				     	if (g_nodeToGet == "U") {
				     		$("#select_all").prop("disabled", false)
				     		$("#div_depth").css("display", "flex")
				     		$("#chk_mycomp").show()
				     		$("#lbl_mycomp").show()
				     	} else if (g_nodeToGet == "D") {
				     		$("#select_all").prop("disabled", true)
				     		$("#div_depth").css("display", "flex")
				     		$("#chk_mycomp").show() 
				     		$("#lbl_mycomp").show()
				     	} else {
				     		$("#select_all").prop("disabled", false)
				     		$("#div_depth").hide()
				     		$("#chk_mycomp").hide()
				     		$("#lbl_mycomp").hide()
				     	}
				    } catch (ex) {
				        hush.util.showEx(ex)
				    }
				// }, function(ex1) {
				// 	alert(survey.util.getErrorMsg(ex1.message, survey.cons.jwt))
				// })
	        }
	
	        const procExpCol = (_expanded, _tag, _idx) => {
	        	const _tagExpcol = $("#expcol_" + _idx)
            	if (_tagExpcol.css("display") == "none") _tagExpcol.show()
            	if (_expanded) { //펼쳐져 있으면 접기 표시
                	g_rs.list[_idx].expanded = false //_tag.attr("expanded", "N")
                	_tagExpcol.attr("src", "/img/plus_1.png")
            	} else {
            		g_rs.list[_idx].expanded = true //_tag.attr("expanded", "Y")
                	_tagExpcol.attr("src", "/img/minus_1.png")
            	}
        	}

            $.when($.ready).done(async function() {
                try {
                    await $.getScript("/common/common.js")
					g_list = $("#listMain")
					g_listSel = $("#listSel")
					const param = new URLSearchParams(location.search)
					g_from = param.get("from")					
					g_nodeToGet = param.get("nodeToGet")
					g_comp = param.get("comp")
					g_expandTo = param.get("expandTo")
					g_expandAllDept = param.get("expandAllDept")
					g_singleSelect = param.get("singleSelect")
					$("#btn_orgtree").click()
					// if (g_nodeToGet == "U") {
					// 	if (g_comp) {
					// 		if (g_comp == g_user.cocd) $("#my_comp").prop("checked", true)
					// 			$("#my_comp").prop("disabled", true)
					// 	} else {
					// 		$("#my_comp").prop("disabled", false)
					// 	}
					//  $("#btn_team").click()
                    // } else if (g_nodeToGet == "D") {
                    // 	if (g_comp) {
                    // 		if (g_comp == g_user.cocd) $("#my_comp").prop("checked", true) //소속부서만
                   	// 		$("#my_comp").prop("disabled", true)
                    // 	} else {
                    // 		$("#my_comp").prop("disabled", false)
                    // 	}
                    // 	$("#btn_team").hide()
                    // 	$("#btn_jojik").click()
                    // } else {
                   	// 	$("#in_search").hide()
                   	// 	$("#btn_search").hide()
                   	// 	$("#btn_team").hide()
                   	// 	$("#btn_jojik").hide()
                   	// 	$("#lbl_comp_guide").show()                    	
                    // 	$("#btn_jojik").click()
                    // }
                    $("#btn_orgtree").click(function() {
	            		getOrgTree({ nodeToGet : g_nodeToGet, comp : g_comp, expandTo : g_expandTo, expandAllDept : g_expandAllDept, singleSelect : g_singleSelect })
                    })
					$("#btn_minus,#btn_plus").click(function() {
	            		const _id = this.id
						g_expandAllDept = ""
                    	let _num = parseInt($("#spn_depth").html())
						if (_id == "btn_minus") {
							if (_num <= 1) {
								_num = 1
							} else {
								_num -= 1
							}
						} else {
							if (_num >= hush.cons.max_level) {
								_num = hush.cons.max_level
							} else {
								_num += 1
							}	
						}
                    	$("#spn_depth").html(_num)
                    	$("#btn_orgtree").click()
                    })
					$("#removeSel").on("click", function() {
                        g_listSel.empty()
                        $(".sel").prop("checked", false)
                        procMemPanel()
                    })
					$("#btn_ok").on("click", function() {
                    	const arr = [ ]
                    	$(".members").each(function() {
                            const idx = parseInt($(this).attr("idx"))
                    		const row = g_rs.list[idx]
                            arr.push(row)
                        })
                        if (arr.length == 0) {
                        	hush.msg.toast("선택한 행이 없습니다.")
                        	return
                        }
						if (g_singleSelect == "Y" && arr.length > 1) {
							hush.msg.msg("하나의 행만 선택 가능합니다.")
							return
						}
                    	if (!opener) {
                    		hush.msg.msg("opener가 존재하지 않습니다.") //개발자오류 chk
                    		return
                    	}
						if (!opener.procFromOrgTree) {
							hush.msg.msg("opener에 procFromOrgTree() 함수가 존재하지 않습니다.") //개발자오류 chk
							return
						}						
						opener.procFromOrgTree(g_from, g_nodeToGet, arr)
						window.close()
                    })
					$("#btn_cancel").on("click", function() { 
						window.close() 
					})
                } catch (ex) {
                    hush.util.showEx(ex)
                }                
            }).fail(function(ex) {
                hush.util.showEx(ex, hush.cons.failOnLoad)
            })
        </script>
    </head>
    <body> 
        <div class="container">
            <div class="top">
                <input id="select_all" type=checkbox style="margin-left: 3px"/>
                <input id="in_search" type=search spellcheck=false autocomplete=off style="width: 80px; height: 28px; margin-left: 5px"/>                
				<div id="btn_search" class="coMenuBtn coActive"><img src="/img/white_search.png" class="coImg16"/><span class="coSpanWithImg">검색</span></div>
				<div id="btn_team" class="coMenuBtn coActive"><img src="/img/white_team.png" class="coImg16"/><span class="coSpanWithImg">내팀</span></div>
				<div id="btn_orgtree" class="coMenuBtn coActive"><img src="/img/white_company.png" class="coImg16"/><span class="coSpanWithImg">조직도</span></div>
				<div id="div_depth" style="display: flex; align-items: center">
					<span id="spn_depth" style="border:1px solid darkgray; padding: 3px; margin-left: 3px">1</span>
					<img id="btn_minus" src="/img/minus.png" class="coImg20 coActive" style="margin-left: 3px"/>
					<img id="btn_plus" src="/img/plus.png" class="coImg20 coActive" style="margin-left: 3px"/>
				</div>
            </div>
            <div class="main">
                <div id="listMain"></div>
                <div id="panSel">
                    <div id="panSelTop">
                        <div style="color: red; margin-left: 3px">선택 : <span id=cntSel>0</span></div>
                        <img id="removeSel" src="/img/close.png" class="coImg16 coActive" style="margin-right: 3px"/>
                    </div>
                    <div id="listSel" style="overflow: auto"></div>
                </div>
            </div>
            <div class="bottom" style="padding: 0 5px">
                <div style="display: flex; align-items: center">
	                <input id="chk_mycomp" type=checkbox /><label id="lbl_mycomp" for="chk_mycomp" style="cursor: pointer; margin-left: 3px">소속회사</label>
	        	</div>
	        	<div style="display: flex; align-items: center">
	                <div id="btn_ok" class="coMenuBtn coActive"><img src="/img/white_yes.png" class="coImg16"/><span class="coSpanWithImg">확인</span></div>
	                <div id="btn_cancel" class="coMenuBtn coActive"><img src="/img/white_no.png" class="coImg16"/><span class="coSpanWithImg">취소</span></div>
	        	</div>
            </div>
        </div>
    </body>
</html>

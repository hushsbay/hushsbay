<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
        <link id=favicon href="/img/hushsbay.png" rel="shortcut icon" type="image/x-icon"/>
        <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
        <title>사용자</title>
        <link rel="stylesheet" href="/common/common.css">
		<link rel="stylesheet" href="/app/org/orgtree.css">	
		<style>
			#gridMain {				
				display: grid;
				grid-template-columns: 100px auto;
				grid-auto-rows: minmax(40px, auto);
				column-gap: 3px;				
				row-gap: 3px;
				grid-template-areas: "lbl_1 fld_1" "lbl_2 fld_2" "lbl_3 fld_3" "lbl_4 fld_4" "lbl_5 fld_5" "lbl_6 fld_6" "lbl_7 fld_7" "lbl_8 fld_8";
			} /* #lbl_1 { grid-area: lbl_1; } #fld_1 { grid-area: fld_1; } #lbl_2 { grid-area: lbl_2; } #fld_2 { grid-area: fld_2; } */

			.cellLabel {
				padding-left: 3px;
				display: flex; align-items: center;
				border: 1px solid lightgray; font-weight: bold;
			}

			.cellField {				
				display: flex; align-items: center; flex-wrap: wrap;
				border: 1px solid lightgray;
			}
		</style>	
        <script src="/plugin/jquery-3.4.1.min.js"></script>
		<script src="/plugin/jquery-ui-smoothness-1.12.1.min.js"></script>
        <script>
			//의도적으로 인증체크하지 않음
			let g_id			

            $.when($.ready).done(async function() {
                try {
                    await $.getScript("/common/common.js")
					const param = new URLSearchParams(location.search)
					g_id = param.get("user_id")
					$("#btn_save").click(async function() {
						try {
							const _id = $("#in_id").val().trim()
							const _nm = $("#in_nm").val().trim()
							const _alias = $("#in_alias").val().trim()
							const _pwd = $("#in_pwd").val().trim()
							const _pwd_1 = $("#in_pwd_1").val().trim()
							const _pwd_2 = $("#in_pwd_2").val().trim()
							const _toporgcd = $("#txt_toporgcd").html()
							const _toporgnm = $("#txt_toporgnm").html()
							const _orgcd = $("#txt_orgcd").html()
							const _orgnm = $("#txt_orgnm").html()
							if (!hush.util.chkFieldVal(_id, "아이디", 4, 20, true)) return
							debugger
							const fd = new FormData()
							fd.append("type", (g_id) ? "U" : "C")
							fd.append("id", _id)
							fd.append("nm", _nm)
							fd.append("alias", _alias)
							fd.append("pwd", _pwd)
							fd.append("pwd_1", _pwd_1)
							fd.append("pwd_2", _pwd_2)
							fd.append("toporgcd", _toporgcd)
							fd.append("toporgnm", _toporgnm)
							fd.append("orgcd", _orgcd)
							fd.append("orgnm", _orgnm)
							const blobUrl = $("#img_pict").attr("src")
							if (blobUrl) {
								const rs = await hush.blob.get(blobUrl)
								fd.append("file", rs.blob)
								fd.append("mimetype", rs.url.mimetype)
							} else {
								fd.append("file", "")
								fd.append("mimetype", "")
							}
							hush.http.ajaxFormData("/user/user", fd, (rs) => {
								if (rs.code != hush.cons.CODE_OK) {
									hush.msg.showMsg(rs.msg)
								} else {
									hush.msg.toast(hush.cons.MSG_OK)
								}
							})
						} catch (ex) {
							hush.util.showEx(ex)
						}
                    })
					$("#pict_browse").click(function() {
                        $("#file_upload").val("")
                        $("#file_upload").trigger("click")
                    })
					$("#file_upload").change(function() {
                        try {
                            const file = this.files[0]
                            const obj = hush.util.getFileNameAndExtension(file.name)
                            if (obj.ext == "" || !hush.cons.ext_image.includes(obj.ext)) {
                                hush.msg.msg("이미지 파일이 필요합니다. (" + hush.cons.ext_image + ")")
                                return
                            }
                            if (file.size > hush.cons.max_image) {
                                hush.msg.msg("이미지 파일 크기 제한 : " + hush.util.formatBytes(hush.cons.max_image) + ". 현재 : " + hush.util.formatBytes(hush.cons.max_image))
                                return
                            }
                            const reader = new FileReader()
                            reader.readAsDataURL(file)
                            reader.addEventListener("load", function () {
                                $("#img_pict").attr("src", reader.result) //$("#img_pict").on("load", function() { $("#pict_upload").click() }).attr("src", reader.result)
                            }, false)
                        } catch (ex) { 
                            hush.util.showEx(ex)
                        }
                    })                    
                } catch (ex) {
                    hush.util.showEx(ex)
                }                
            }).fail(function(ex) {
                hush.util.showEx(ex, hush.cons.failOnLoad)
            })
        </script>
    </head>
    <body> 
        <div class="container">
			<div class="top">
				<div id="btn_save" class="coMenuBtn coActive"><img src="/img/white_yes.png" class="coImg16"/><span class="coSpanWithImg">저장</span></div>
				<div id="btn_delete" class="coMenuBtn coActive"><img src="/img/white_trash.png" class="coImg16"/><span class="coSpanWithImg">삭제</span></div>
			</div>
            <div class="main" style="width:100%;flex-direction:column">
				<div style="width:100%;padding:5px">설명 내용..</div>
                <div id="gridMain" style="width:100%">		

					<div id="lbl_1" class="cellLabel">아이디</div>
					<div id="fld_1" class="cellField">
						<input id="in_id" spellcheck=false autocomplete=off style="width: 140px"/>
					</div>
					
					<div id="lbl_2" class="cellLabel">이름</div>
					<div id="fld_2" class="cellField">
						<input id="in_nm" spellcheck=false autocomplete=off style="width: 200px"/>
					</div>
					
					<div id="lbl_3" class="cellLabel">별칭(Alias)</div>
					<div id="fld_3" class="cellField">
						<input id="in_alias" spellcheck=false autocomplete=off style="width: 200px"/>
					</div>
					
					<div id="lbl_4" class="cellLabel">비번</div>
					<div id="fld_4" class="cellField">
						<input id="in_pwd" spellcheck=false autocomplete=off style="width: 140px"/>
						<input id="chk_pwd" type=checkbox style="margin-left: 5px"/><label id="lbl_pwd" for="chk_pwd" style="cursor: pointer">비번변경</label>
					</div>
					
					<div id="lbl_5" class="cellLabel">새비번</div>
					<div id="fld_5" class="cellField">
						<input id="in_pwd_1" spellcheck=false autocomplete=off style="width: 140px"/>
					</div>

					<div id="lbl_6" class="cellLabel">새비번(확인)</div>
					<div id="fld_6" class="cellField">
						<input id="in_pwd_2" spellcheck=false autocomplete=off style="width: 140px"/>
					</div>
					
					<div id="lbl_7" class="cellLabel">소속<button>선택</button></div>
					<div id="fld_7" class="cellField">
						<div id="txt_toporgcd" style="display: none"></div>
						<div id="txt_orgcd" style="display: none"></div>						
						<div id="txt_toporgnm" style="margin: 0 5px"></div>
						<div id="txt_orgnm" style="margin: 0 5px"></div>						
					</div>

					<div id="lbl_8" class="cellLabel">사진<button id="pict_browse">선택</button></div>
					<div id="fld_8" class="cellField">						
						<img id="img_pict" style="width: 64px; height: 64px; margin: 5px" />
					</div>

				</div>
            </div>
			<input id=file_upload type=file accept="image/*" style="display: none">
        </div>
    </body>
</html>

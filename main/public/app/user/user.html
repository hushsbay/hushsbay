<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
        <link id=favicon href="/img/hushsbay.png" rel="shortcut icon" type="image/x-icon"/>
        <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
        <title>사용자</title>
        <link rel="stylesheet" href="/common/common.css">
		<link rel="stylesheet" href="/app/org/orgtree.css">	
		<style>
			#gridMain {				
				display: grid;
				grid-template-columns: 100px auto;
				grid-auto-rows: minmax(40px, auto);
				column-gap: 3px;				
				row-gap: 3px;
				grid-template-areas: "lbl_id fld_id" "lbl_nm fld_nm" "lbl_alias fld_alias" "lbl_pwd fld_pwd" "lbl_pwd_1 fld_pwd_1" "lbl_pwd_2 fld_pwd_2" "lbl_org fld_org" "lbl_img fld_img";
			} /* #lbl_id { grid-area: lbl_id; } #fld_id { grid-area: fld_id; } #lbl_nm { grid-area: lbl_nm; } #fld_nm { grid-area: fld_nm; } .. */

			.cellLabel {
				padding-left: 3px;
				display: flex; align-items: center;
				border: 1px solid lightgray; font-weight: bold;
			}

			.cellField {				
				display: flex; align-items: center; flex-wrap: wrap;
				border: 1px solid lightgray;
			}

			.pict {
				width: 64px; height: 64px; margin: 5px
			}
		</style>	
        <script src="/plugin/jquery-3.4.1.min.js"></script>
		<script src="/plugin/jquery-ui-smoothness-1.12.1.min.js"></script>
        <script>
			//의도적으로 인증체크하지 않음
			let g_mode		

			function procFromOrgTree(from, nodeToGet, arr) {
        		try {
	        		if (!$.isArray(arr) || arr.length == 0) {
	        			hush.msg.msg("조직도 팝업으로부터 선택한 값이 없습니다.")
	        			return
	        		}
					$("#txt_toporgcd").html(arr[0].TOP_ORG_CD)
					$("#txt_toporgnm").html(arr[0].TOP_ORG_NM)
					$("#txt_orgcd").html(arr[0].ORG_CD)
					$("#txt_orgnm").html(arr[0].ORG_NM)
        		} catch (ex) {
                	hush.util.showEx(ex)
                }
        	}

			function dispPwd(show) {
				if (show) {
					$("#lbl_pwd_1").css("display", "flex")
					$("#fld_pwd_1").css("display", "flex")
					$("#lbl_pwd_2").css("display", "flex")
					$("#fld_pwd_2").css("display", "flex")
				} else {
					$("#lbl_pwd_1").hide()
					$("#fld_pwd_1").hide()
					$("#lbl_pwd_2").hide()
					$("#fld_pwd_2").hide()
				}
			}

            $.when($.ready).done(async function() {
                try {
                    await $.getScript("/common/common.js")
					const param = new URLSearchParams(location.search)
					const id = param.get("user_id")
					g_mode = id ? "U" : "C"
					if (g_mode == "C") { //신규모드
						$("#btn_delete").hide()
						$("#lbl_pwd").hide()
						$("#fld_pwd").hide()
					} else { //수정모드
						$("#in_id").prop("disabled", true)
						dispPwd(false)
						const rs = await hush.http.ajax("/user/getuser", { id : id })
						if (rs.code != hush.cons.CODE_OK) {
							hush.msg.showMsg(rs.msg)
							return
						}
						const _len = rs.list.length
						if (_len == 0) return
						const row = rs.list[0]
						$("#in_id").val(row.USER_ID)
						$("#in_nm").val(row.USER_NM)
						$("#in_alias").val(row.NICK_NM)
						$("#txt_toporgcd").html(row.TOP_ORG_CD)
						$("#txt_toporgnm").html(row.TOP_ORG_NM)
						$("#txt_orgcd").html(row.ORG_CD)
						$("#txt_orgnm").html(row.ORG_NM)
						if (row.PICTURE) {
							//const blobUrl = hush.blob.getBlobUrlForImage(row.PICTURE.data, row.MIMETYPE)
							//$("#img_pict").attr("src", blobUrl)

							const dataUrl = hush.blob.setDataUrl(rs.picture, row.MIMETYPE) //서버에서 base64(rs.picture)로 내려줌
							$("#img_pict").attr("src", dataUrl)


							
						}
					}
					$("#btn_save").click(async function() {
						try {
							const _chkPwd = $("#chk_pwd").prop("checked")
							const _id = $("#in_id").val().trim()
							const _nm = $("#in_nm").val().trim()
							const _alias = $("#in_alias").val().trim()
							const _pwd = $("#in_pwd").val().trim()
							const _pwd_1 = (g_mode == "C" || _chkPwd) ? $("#in_pwd_1").val().trim() : ""
							const _pwd_2 = (g_mode == "C" || _chkPwd) ? $("#in_pwd_2").val().trim() : ""
							const _toporgcd = $("#txt_toporgcd").html()
							const _toporgnm = $("#txt_toporgnm").html()
							const _orgcd = $("#txt_orgcd").html()
							const _orgnm = $("#txt_orgnm").html()
							if (g_mode == "C" || _chkPwd) { //신규모드 또는 수정모드중 비번 변경시
								if (!hush.util.chkFieldVal(_pwd_1, "새비번", 4, 20, true)) return	
								if (_pwd_1 != _pwd_2) {
									hush.msg.msg("비번과 비번(확인용)이 다릅니다.")
									return
								}
							}
							if (g_mode == "U") {
								if (!hush.util.chkFieldVal(_pwd, "비번", 4, 20, true)) return	
							}
							if (!hush.util.chkFieldVal(_id, "아이디", 4, 20, true)) return
							
							const fd = new FormData()
							fd.append("type", g_mode)
							fd.append("id", _id)
							fd.append("nm", _nm)
							fd.append("alias", _alias)
							fd.append("pwd", _pwd)
							fd.append("pwd_1", _pwd_1) //서버에는 pwd_2 필요없음
							fd.append("toporgcd", _toporgcd)
							fd.append("toporgnm", _toporgnm)
							fd.append("orgcd", _orgcd)
							fd.append("orgnm", _orgnm)
							const dataUrl = $("#img_pict").attr("src")
							if (dataUrl) {
								const rs = await hush.blob.get(dataUrl)
								fd.append("file", rs.blob)
								fd.append("mimetype", rs.url.mimetype)
							} else {
								fd.append("file", "")
								fd.append("mimetype", "")
							}
							hush.http.ajaxFormData("/user/setuser", fd, (rs) => {
								if (rs.code != hush.cons.CODE_OK) {
									hush.msg.showMsg(rs.msg)
								} else {
									hush.msg.toast(hush.cons.MSG_OK)
								}
							})
						} catch (ex) {
							hush.util.showEx(ex)
						}
                    })
					$("#chk_pwd").change(function() {
						const _self = $(this)
						dispPwd(_self.prop("checked"))
					})
					$("#btn_orgtree").on("click", function() {
                        const obj = { from : this.id, nodeToGet : "D", expandTo : 99, singleSelect : "Y", selectOnlyChildDept : "Y" }
                        hush.util.openWinPop("/app/org/orgtree.html?" + $.param(obj))
                    })
					$("#pict_browse").click(function() {
                        $("#file_upload").val("")
                        $("#file_upload").trigger("click")
                    })
					$("#pict_clear").click(function() {
                        $("#img_pict").remove() //$("#img_pict").attr("src", "") //DB에 가비지가 남아 있어 문제가 됨
						$("#fld_img").prepend("<img id='img_pict' class='pict' />")
						hush.msg.toast("저장해야 최종 적용됩니다.")
                    })
					$("#file_upload").change(function() {
                        try {
                            const file = this.files[0]
                            const obj = hush.util.getFileNameAndExtension(file.name)
                            if (obj.ext == "" || !hush.cons.ext_image.includes(obj.ext)) {
                                hush.msg.msg("이미지 파일이 필요합니다. (" + hush.cons.ext_image + ")")
                                return
                            }
                            if (file.size > hush.cons.max_image) {
                                hush.msg.msg("이미지 파일 크기 제한 : " + hush.util.formatBytes(hush.cons.max_image) + ". 현재 : " + hush.util.formatBytes(hush.cons.max_image))
                                return
                            }
                            // const reader = new FileReader()
                            // reader.readAsDataURL(file)
                            // reader.addEventListener("load", function () { //$("#img_pict").on("load", function() { $("#pict_upload").click() }).attr("src", reader.result)
                            //     $("#img_pict").attr("src", reader.result) //reader.result는 base64 인코딩된 스트링 데이터
                            // }) //, false)
							debugger
							const reader = new FileReader()
							reader.onload = function(e) {
								const blob = new Blob([new Uint8Array(e.target.result)], {type: "image/png" })
								console.log(blob)
								const blobUrl = URL.createObjectURL(blob)
								$("#img_pict").attr("src", blobUrl)
							}
							reader.readAsArrayBuffer(file)

							//const uInt8Array = new Uint8Array(file.buffer)
							//const blob = new Blob([uInt8Array], { type: "image/png" })
							//const blobUrl = URL.createObjectURL(blob)
							//$("#img_pict").attr("src", blobUrl)
                        } catch (ex) { 
                            hush.util.showEx(ex)
                        }
                    })                    
                } catch (ex) {
                    hush.util.showEx(ex)
                }                
            }).fail(function(ex) {
                hush.util.showEx(ex, hush.cons.failOnLoad)
            })
        </script>
    </head>
    <body> 
        <div class="container">
			<div class="top">
				<div id="btn_save" class="coMenuBtn coActive"><img src="/img/white_yes.png" class="coImg16"/><span class="coSpanWithImg">저장</span></div>
				<div id="btn_delete" class="coMenuBtn coActive"><img src="/img/white_trash.png" class="coImg16"/><span class="coSpanWithImg">삭제</span></div>
			</div>
            <div class="main" style="width:100%;flex-direction:column">
				<div style="width:100%;padding:5px">설명 내용..</div>
                <div id="gridMain" style="width:100%">		

					<div id="lbl_id" class="cellLabel">아이디</div>
					<div id="fld_id" class="cellField">
						<input id="in_id" spellcheck=false autocomplete=off style="width: 140px"/>
					</div>
					
					<div id="lbl_nm" class="cellLabel">이름</div>
					<div id="fld_nm" class="cellField">
						<input id="in_nm" spellcheck=false autocomplete=off style="width: 200px"/>
					</div>
					
					<div id="lbl_alias" class="cellLabel">별칭(Alias)</div>
					<div id="fld_alias" class="cellField">
						<input id="in_alias" spellcheck=false autocomplete=off style="width: 200px"/>
					</div>
					
					<div id="lbl_pwd" class="cellLabel">비번</div>
					<div id="fld_pwd" class="cellField">
						<input id="in_pwd" type=password spellcheck=false autocomplete=off style="width: 140px"/>
						<input id="chk_pwd" type=checkbox style="margin-left: 5px"/><label id="lbl_pwd" for="chk_pwd" style="cursor: pointer">비번변경</label>
					</div>
					
					<div id="lbl_pwd_1" class="cellLabel">새비번</div>
					<div id="fld_pwd_1" class="cellField">
						<input id="in_pwd_1" type=password spellcheck=false autocomplete=off style="width: 140px"/>
					</div>

					<div id="lbl_pwd_2" class="cellLabel">새비번(확인)</div>
					<div id="fld_pwd_2" class="cellField">
						<input id="in_pwd_2" type=password spellcheck=false autocomplete=off style="width: 140px"/>
					</div>
					
					<div id="lbl_org" class="cellLabel">소속<button id="btn_orgtree">선택</button></div>
					<div id="fld_org" class="cellField">
						<div id="txt_toporgcd" style="display: none"></div>
						<div id="txt_orgcd" style="display: none"></div>						
						<div id="txt_toporgnm" style="margin: 0 5px"></div>
						<div id="txt_orgnm" style="margin: 0 5px"></div>						
					</div>

					<div id="lbl_img" class="cellLabel">사진<button id="pict_browse">선택</button></div>
					<div id="fld_img" class="cellField">						
						<img id="img_pict" class="pict" /> <button id="pict_clear">Clear</button></div>
					</div>

				</div>
            </div>
			<input id=file_upload type=file accept="image/*" style="display: none">
        </div>
    </body>
</html>
